# é…ç½®ä¸­å¿ƒ

## æ¦‚è¿°

é…ç½®ä¸­å¿ƒï¼ˆkylin-cloud-configserverï¼‰ä½¿ç”¨[Spring Cloud](http://cloud.spring.io/spring-cloud-static/spring-cloud.html#_spring_cloud_config)å®ç°åˆ†å¸ƒå¼ç¯å¢ƒé…ç½®çš„ç»Ÿä¸€ç®¡ç†ï¼Œç›®å‰é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨[git](http://code.59store.com/groups/config)ä¸­ï¼Œåº”ç”¨é€šè¿‡æ‹‰å–é…ç½®ä¸­å¿ƒçš„é…ç½®å¯åŠ¨åº”ç”¨ã€‚

## ä½¿ç”¨è¯´æ˜

### æ¥å…¥

å‚è€ƒ:
1. [åŸºç¡€æ¡†æ¶é›†æˆ](https://doc.oschina.net/kylin)
1. [kylin-cloudå¿«é€Ÿæ¥å…¥æŒ‡å—](https://doc.oschina.net/kylin?t=55222)
1. [éƒ¨ç½²æ¶æ„](https://doc.oschina.net/kylin?t=55353)

### å®šä¹‰é…ç½®

å®šä¹‰åº”ç”¨é…ç½®è§„åˆ™å¦‚ä¸‹ï¼š
1. kylin.cloud.config.namesé…ç½®é¡¹ï¼Œæ”¯æŒå¤šä¸ªé…ç½®ï¼ˆå¤šä¸ªé…ç½®ç”¨é€—å·éš”å¼€ï¼‰ï¼›
1. kylin.cloud.config.nameï¼ˆåœ¨æ²¡æœ‰kylin.cloud.config.namesé…ç½®é¡¹çš„æƒ…å†µä¸‹æœ‰æ•ˆï¼‰ï¼Œæ”¯æŒè®¾ç½®å•ä¸ªé…ç½®ã€‚è¯¥é…ç½®é¡¹å€¼ä¸ºç©ºæ—¶ï¼Œè¡¨ç¤ºé¡¹ç›®æ— éœ€é…ç½®ï¼›
1. å½“ä¸Šé¢çš„é…ç½®éƒ½ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä½¿ç”¨åº”ç”¨åå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼š${appName}.yml


å¦å¤–ï¼Œè¿˜æœ‰2ä¸ªå…¨å±€é…ç½®ï¼š
1. kylin.yml  
  kylinæ¡†æ¶ç»Ÿä¸€é…ç½®æ–‡ä»¶
1. global.yml  
  å…¨å±€é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«Redisã€MQã€loggingã€statsdã€RPCæœåŠ¡ç­‰å…¨å±€é…ç½®


å¯¹äºæ¥å…¥é…ç½®ä¸­å¿ƒçš„åº”ç”¨æ¥è¯´ï¼ˆä¾èµ–kylin-cloud-clientï¼‰ï¼Œåº”ç”¨å¯åŠ¨çš„æ—¶å€™è¯»å–é…ç½®è§„åˆ™ï¼šglobal,kylin,${kylin.cloud.config.names:${kylin.cloud.config.name:${spring.application.name}}}ï¼Œé…ç½®çš„ä¼˜å…ˆçº§ä¾æ¬¡é€’å¢ã€‚

ç”±äºglobalæ–‡ä»¶å®šä¹‰äº†redisã€MQï¼Œä¹‹å‰éœ€è¦æ¯ä¸ªåº”ç”¨å®šä¹‰å¾ˆå¤šé€šç”¨çš„é…ç½®ï¼Œç°åœ¨ç»Ÿç»Ÿä¸ç”¨ç®¡äº†ã€‚åº”ç”¨åªéœ€è¦ä¾èµ–ç›¸åº”çš„jaråŒ…å³å¯ä½¿ç”¨ï¼Œçœå¿ƒçœåŠ›ã€‚

### åˆ·æ–°é…ç½®

é…ç½®ä¸­å¿ƒè®¢é˜…äº†gitlabçš„webhooksçš„Push eventsï¼Œå½“æœ‰é…ç½®æ–‡ä»¶å˜æ›´æ—¶ä¼šé€šè¿‡Spring Cloud Busé€šçŸ¥ç›¸åº”çš„åº”ç”¨åˆ·æ–°é…ç½®ï¼ˆA Spring @Bean that is marked as @RefreshScopeï¼‰

NOTEï¼š
ç”±äºç›®å‰åº”ç”¨ååŒ…å«â€œ-â€ç¬¦å·ï¼Œé…ç½®ä¸­å¿ƒçŒœæµ‹ç›®æ ‡åº”ç”¨åï¼Œä¼šå¯¼è‡´ä¼šå‘é€å¤šä¸ªé…ç½®å˜æ›´äº‹ä»¶ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ— æ•ˆæˆ–í ½å…¨éƒ¨æ— æ•ˆã€‚
å¦‚order-serivceé…ç½®å˜æ›´ï¼Œä¼šå‘é€2ä¸ªé…ç½®å˜æ›´äº‹ä»¶ï¼Œç›®æ ‡åº”ç”¨åä¸ºorder:service:**å’Œorder-service:**ï¼Œå…¶ä¸­ç›®æ ‡åº”ç”¨åä¸ºorder:service:**çš„æ¶ˆæ¯æ˜¯æ— æ•ˆçš„ã€‚
**æ‰€æœ‰å»ºè®®é…ç½®æ–‡ä»¶çš„åç§°ä¸è¦åŒ…æ‹¬â€œ-â€ç¬¦å·**

### åº”ç”¨é—´é€šä¿¡

ä¾èµ–äº†kylin-cloud-clientçš„åº”ç”¨é—´ï¼Œæ”¯æŒåº”ç”¨é—´äº’ç›¸é€šä¿¡ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. å®šä¹‰äº‹ä»¶ï¼Œí ½ä¸€å®šè¦æ”¾åœ¨org.springframework.cloud.bus.eventåŒ…ä¸‹
```java
/**
 * Only for testing.
 * 
 * @author <a href="mailto:zhuzm@59store.com">å¤©æ²³</a>
 * @version 1.0 2016å¹´9æœˆ21æ—¥
 * @since 1.0
 */
public class RefreshCacheRemoteApplicationEvent extends RemoteApplicationEvent {
    private static final long serialVersionUID = 5471477402537062063L;

    /**
     * 
     */
    public RefreshCacheRemoteApplicationEvent() {
        super();
    }

    /**
     * @param source
     * @param originService
     * @param destinationService
     */
    public RefreshCacheRemoteApplicationEvent(Object source, String originService, String destinationService) {
        super(source, originService, destinationService);
    }

    /**
     * @param source
     * @param originService
     */
    public RefreshCacheRemoteApplicationEvent(Object source, String originService) {
        super(source, originService);
    }

}
```
1. å‘å¸ƒäº‹ä»¶
```java
/**
 * Only for testing.
 * 
 * @author <a href="mailto:zhuzm@59store.com">å¤©æ²³</a>
 * @version 1.0 2016å¹´9æœˆ21æ—¥
 * @since 1.0
 */
@Configuration
public class RefreshCacheEventPublisherAware implements ApplicationEventPublisherAware, ApplicationContextAware {
    private ApplicationEventPublisher applicationEventPublisher;

    /**
     * å‘å¸ƒåˆ·æ–°ç¼“å­˜äº‹ä»¶.
     */
    @Scheduled(fixedRate = 10000)
    public void refreshListener() {
        this.applicationEventPublisher.publishEvent(new RefreshCacheRemoteApplicationEvent(this, contextId)); // å‘ç»™æ‰€æœ‰ç³»ç»Ÿ
        this.applicationEventPublisher.publishEvent(new RefreshCacheRemoteApplicationEvent(this, contextId, "order-service")); // å‘ç»™order-serviceç³»ç»Ÿï¼Œå»ºè®®ç³»ç»Ÿåä¸å¸¦â€œ-â€ç¬¦å·ï¼Œå³orderservice
    }

    /**
     * @see org.springframework.context.ApplicationEventPublisherAware#setApplicationEventPublisher(org.springframework.context.ApplicationEventPublisher)
     */
    @Override
    public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) {
        this.applicationEventPublisher = applicationEventPublisher;
    }

    private String contextId = UUID.randomUUID().toString();

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.contextId = applicationContext.getId();
    }

}
```
1. ç›‘å¬äº‹ä»¶
```java
/**
 * Only for testing.
 * 
 * @author <a href="mailto:zhuzm@59store.com">å¤©æ²³</a>
 * @version 1.0 2016å¹´9æœˆ21æ—¥
 * @since 1.0
 */
@Component
public class RefreshCacheEventListener implements ApplicationListener<RefreshCacheRemoteApplicationEvent> {
    private static final Logger logger = LoggerFactory.getLogger(RefreshCacheEventListener.class);

    /**
     * @see org.springframework.context.ApplicationListener#onApplicationEvent(org.springframework.context.ApplicationEvent)
     */
    @Override
    public void onApplicationEvent(RefreshCacheRemoteApplicationEvent event) {
        logger.info("åˆ·æ–°ç¼“å­˜");
    }

}
```

NOTEï¼š
RemoteApplicationEventçš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éœ€è¦èƒ½è®¿é—®äº‹ä»¶ç±»ï¼Œå¦åˆ™ä¼šæŠ¥æ¶ˆè´¹å¼‚å¸¸ã€‚